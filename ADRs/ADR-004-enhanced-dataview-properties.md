# ADR-004: Enhanced DataView Properties with Plan Index

**Status**: Proposed  
**Date**: 2025-12-02  
**Decision Makers**: deltajuliet  
**Supersedes**: N/A  
**Related to**: ADR-001 (Bible Study Planner Architecture)

---

## Context

The current frontmatter metadata has two key limitations:

### Issue 1: Inadequate Book Tracking

When a reading day includes multiple books, only the primary book is captured:

```yaml
book: Luke  # Only first book
chapters: ['1-24', '1-21', ...]  # Multiple books but unclear which is which
```

### Issue 2: No Study Plan Management

- No way to identify or distinguish between different plans
- Cannot track plan-level metadata (status, progress, settings)
- No central dashboard for progress tracking
- Plan metadata would need to be duplicated in every daily note

---

## Decision

Implement a **Plan Index File** system with enhanced daily note metadata:

### 1. Plan Index File

Generate a separate `_plan-index-{plan-id}.md` file that contains:
- Plan metadata (name, dates, scope, strategy)
- Plan-level status and settings
- Embedded DataView queries for progress tracking
- Link to all daily reading notes

### 2. Enhanced Daily Notes

Update daily notes with:
- `books` array (not singular `book`)
- Reference to `plan_id` (not full plan details)
- Structured chapters field for multi-book days

---

## Design

### Plan Index File Structure

**Filename**: `_plan-index-{plan-id}.md`  
**Location**: Parent directory of daily notes folder  
**Example**: `_plan-index-complete-2025.md`

**Content:**

```markdown
---
type: bible-study-plan-index
plan_id: complete-2025-canonical
plan_name: "Complete Bible 2025"
plan_strategy: canonical
plan_scope: complete
plan_start_date: 2025-01-01
plan_end_date: 2025-12-31
plan_total_days: 365
plan_created: 2025-01-01T10:00:00
plan_status: active
output_folder: "./2025-complete"
tags: [bible-study, plan-index, 2025]
---

# ðŸ“– Complete Bible 2025

**Reading Plan Index & Dashboard**

## Plan Details

| Property | Value |
|----------|-------|
| **Plan ID** | `complete-2025-canonical` |
| **Strategy** | Canonical (Book Order) |
| **Scope** | Complete Bible (66 books) |
| **Duration** | 365 days |
| **Start Date** | January 1, 2025 |
| **End Date** | December 31, 2025 |
| **Status** | Active |
| **Created** | 2025-01-01 |

## ðŸ“Š Progress Dashboard

### Overall Progress

\`\`\`dataview
TABLE WITHOUT ID
  ("ðŸŽ¯ " + round((length(rows.file) / {{TOTAL_DAYS}}) * 100, 1) + "%") as "Progress",
  length(rows.file) as "Days Completed",
  ({{TOTAL_DAYS}} - length(rows.file)) as "Days Remaining",
  sum(rows.verse_count) as "Verses Read",
  round(sum(rows.estimated_minutes) / 60, 1) + "h" as "Time Invested"
FROM "{{OUTPUT_FOLDER}}"
WHERE plan_id = "{{PLAN_ID}}" AND status = "completed"
\`\`\`

### Reading Pace

\`\`\`dataview
TABLE WITHOUT ID
  file.link as "Day",
  books as "Books",
  verse_count as "Verses",
  estimated_minutes + " min" as "Time"
FROM "{{OUTPUT_FOLDER}}"
WHERE plan_id = "{{PLAN_ID}}"
SORT date DESC
LIMIT 7
\`\`\`

### Books Completed

\`\`\`dataview
TABLE WITHOUT ID
  book as "Book",
  length(rows.file) as "Days",
  sum(rows.verse_count) as "Verses"
FROM "{{OUTPUT_FOLDER}}"
WHERE plan_id = "{{PLAN_ID}}" AND status = "completed"
FLATTEN books as book
GROUP BY book
SORT book ASC
\`\`\`

### Testament Progress

\`\`\`dataview
TABLE WITHOUT ID
  testament as "Testament",
  length(rows.file) as "Days Completed",
  sum(rows.verse_count) as "Verses Read",
  round(sum(rows.estimated_minutes) / 60, 1) + "h" as "Time"
FROM "{{OUTPUT_FOLDER}}"
WHERE plan_id = "{{PLAN_ID}}" AND status = "completed"
GROUP BY testament
\`\`\`

### Upcoming Readings

\`\`\`dataview
TABLE WITHOUT ID
  file.link as "Day",
  date as "Date",
  books as "Books",
  verse_count as "Verses"
FROM "{{OUTPUT_FOLDER}}"
WHERE plan_id = "{{PLAN_ID}}" AND status = "pending"
SORT date ASC
LIMIT 7
\`\`\`

### Missed Days

\`\`\`dataview
LIST
FROM "{{OUTPUT_FOLDER}}"
WHERE plan_id = "{{PLAN_ID}}" 
  AND status = "pending" 
  AND date < date(today)
SORT date ASC
\`\`\`

## ðŸ“š All Readings

\`\`\`dataview
TABLE
  day as "Day #",
  date as "Date",
  books as "Books",
  verse_count as "Verses",
  status as "Status"
FROM "{{OUTPUT_FOLDER}}"
WHERE plan_id = "{{PLAN_ID}}"
SORT date ASC
\`\`\`

## Notes

*Use this space to track overall plan insights, goals, or modifications*


---

**Generated by**: Bible Study Planner v1.3  
**File Location**: `{{OUTPUT_FOLDER}}`
```

### Daily Note Structure

**Simplified frontmatter** (no repeated plan metadata):

```yaml
---
date: 2025-01-01
day: 1
plan_id: complete-2025-canonical
tags: ['bible-study', 'daily', 'old', 'law']
testament: old
genre: law
books: [Genesis]
chapters: "1-3"
estimated_minutes: 12
verse_count: 80
word_count: 2000
status: pending
---
```

**Multi-book day:**

```yaml
---
date: 2025-03-17
day: 76
plan_id: nt-2025-sprint
tags: ['bible-study', 'daily', 'new', 'gospels', 'epistles']
testament: new
genre: gospels
books: [Luke, John, Acts, Romans, 1 Corinthians]
chapters:
  - book: Luke
    range: "1-24"
  - book: John
    range: "1-21"
  - book: Acts
    range: "1-28"
  - book: Romans
    range: "1-16"
  - book: 1 Corinthians
    range: "1-16"
estimated_minutes: 722
verse_count: 6208
word_count: 141695
status: pending
---
```

---

## Key Design Decisions

### 1. Books Field (Array, Not Singular)

**Decision**: Use `books` array, drop singular `book`

**Rationale:**
- Single source of truth
- Works for both single and multi-book days
- Clean DataView queries: `contains(books, "Romans")`
- No redundancy or confusion

### 2. Plan Index File Benefits

**Centralized Management:**
- Update plan status in one place
- Track plan-level metadata
- Dashboard with embedded queries
- No duplication across 365 files

**Improved Organization:**
- Clear plan overview
- Progress tracking at a glance
- Easy to find and reference
- Reduces clutter in daily notes

### 3. File Naming Convention

**Plan Index**: `_plan-index-{plan-id}.md`
- Underscore prefix sorts to top
- Clear purpose from filename
- Unique per plan ID

**Example**:
- `_plan-index-complete-2025.md`
- `_plan-index-nt-sprint.md`
- `_plan-index-family-devotional.md`

### 4. DataView Query Templates

Queries use placeholders replaced during generation:
- `{{PLAN_ID}}` â†’ actual plan ID
- `{{OUTPUT_FOLDER}}` â†’ path to daily notes
- `{{TOTAL_DAYS}}` â†’ total days in plan

This makes queries dynamic and reusable.

### 5. Plan ID Reference

Daily notes only store `plan_id`, not full plan details:

**Benefits:**
- Smaller daily note files
- Update plan info in one place
- Easy to query all notes for a plan
- Can link back to plan index

---

## Implementation Plan

### Phase 1: Core Implementation (v1.3)

**Changes:**

1. **CLI Updates** (`cli.py`):
   - Add `--plan-name` and `--plan-id` options
   - Implement auto-generation for plan names/IDs
   - Generate plan index file alongside daily notes

2. **Plan Index Generation**:
   - Create `_generate_plan_index()` function
   - Template with dynamic DataView queries
   - Write to parent directory of output folder

3. **Daily Note Updates**:
   - Replace `book:` with `books:` array
   - Add `plan_id` reference
   - Implement structured chapters for multi-book days
   - Remove redundant plan metadata

4. **StudyDay Model** (`models/study_day.py`):
   - Add method to extract all book names
   - Support plan_id property

**Files to Modify:**
- `bible_study_planner/cli.py`
- `bible_study_planner/models/study_day.py`

### Phase 2: Enhanced Features (v1.4)

- Plan comparison tools
- Progress notifications
- Plan templates
- Custom query builder

---

## File Structure Example

```
Obsidian-Vault/
â”œâ”€â”€ Bible-Study/
â”‚   â”œâ”€â”€ _plan-index-complete-2025.md        # Plan dashboard
â”‚   â”œâ”€â”€ 2025-complete/                       # Daily notes folder
â”‚   â”‚   â”œâ”€â”€ 2025-01-01-day-001.md
â”‚   â”‚   â”œâ”€â”€ 2025-01-02-day-002.md
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ _plan-index-nt-sprint.md            # Another plan
â”‚   â””â”€â”€ 2025-nt-sprint/
â”‚       â”œâ”€â”€ 2025-03-01-day-001.md
â”‚       â””â”€â”€ ...
```

---

## CLI Changes

### New Options

```bash
--plan-name TEXT         Human-readable plan name
--plan-id TEXT           Unique plan identifier (auto-generated)
```

### Usage Examples

**Default (auto-generated names):**
```bash
bible-study-planner generate --scope complete --start-date 2025-01-01
# Creates: "Complete Bible 2025" with ID "complete-2025-canonical"
```

**Custom plan naming:**
```bash
bible-study-planner generate \
  --scope nt \
  --start-date 2025-03-01 \
  --end-date 2025-03-31 \
  --plan-name "March NT Challenge" \
  --plan-id "march-nt-2025" \
  --output ./bible-study/march-nt
```

**Multiple concurrent plans:**
```bash
# Personal plan
bible-study-planner generate \
  --scope complete \
  --plan-name "Personal 2025" \
  --output ./bible-study/personal

# Family plan
bible-study-planner generate \
  --scope nt \
  --plan-name "Family Devotional" \
  --output ./bible-study/family
```

---

## DataView Query Examples

### Using Plan Index Queries

The plan index file contains ready-to-use queries. Users just open the index file to see:
- Progress percentage
- Books completed
- Upcoming readings
- Missed days

### Custom Queries

**Find all notes for a plan:**
```dataview
FROM "bible-study/2025-complete"
WHERE plan_id = "complete-2025-canonical"
```

**Compare multiple plans:**
```dataview
TABLE 
  plan_id,
  length(rows) as "Days",
  sum(rows.verse_count) as "Verses"
FROM "bible-study"
GROUP BY plan_id
```

**Books read across all plans:**
```dataview
TABLE file.folder as "Plan", books
FROM "bible-study"
FLATTEN books as book
WHERE book = "Romans"
```

---

## Consequences

### Positive

1. **Centralized Management**: One file for plan metadata and dashboard
2. **No Duplication**: Plan details not repeated 365 times
3. **Live Dashboard**: Embedded DataView queries show real-time progress
4. **Cleaner Notes**: Daily notes have minimal, relevant metadata only
5. **Easy Updates**: Change plan status or details in one place
6. **Multiple Plans**: Clear separation between concurrent plans
7. **Better UX**: Users get an instant progress overview

### Negative

1. **Extra File**: One additional file per plan
   - Mitigation: Provides significant value, well worth it
2. **DataView Dependency**: Dashboard requires DataView plugin
   - Mitigation: DataView is very popular in Obsidian community

### Neutral

1. **File Organization**: Slightly different structure with index files
2. **Learning Curve**: Users learn about plan index concept

---

## Migration Guide

### For New Plans

Just use the new version - plan index generated automatically.

### For Existing Plans

1. **Regenerate** (easiest):
   ```bash
   bible-study-planner generate --scope complete --start-date 2025-01-01
   ```

2. **Manual Update** (if you have custom notes):
   - Change `book:` to `books:` array in frontmatter
   - Add `plan_id` field
   - Create plan index file manually (or let tool generate it)

---

## Testing Strategy

### Unit Tests

1. **Plan Index Generation**:
   - Template rendering
   - Query placeholder replacement
   - File naming
   - Path resolution

2. **Books Array**:
   - Single-book days
   - Multi-book days
   - Proper YAML formatting

3. **Plan ID Generation**:
   - Auto-generation logic
   - Custom ID validation
   - Uniqueness checking

### Integration Tests

1. **Full Generation**:
   - Plan index file created
   - Contains correct metadata
   - DataView queries are valid
   - Daily notes reference correct plan_id

2. **Multiple Plans**:
   - Generate two plans
   - Verify separate index files
   - Confirm no cross-contamination

### Manual Tests

```bash
# Test 1: Default plan
py -m bible_study_planner generate --scope nt --days 7

# Test 2: Custom plan
py -m bible_study_planner generate \
  --scope complete \
  --plan-name "Test Plan" \
  --plan-id "test-2025"

# Test 3: Multiple plans
py -m bible_study_planner generate --scope ot --plan-name "OT" --output ./test/ot
py -m bible_study_planner generate --scope nt --plan-name "NT" --output ./test/nt
```

**Verify**:
- Plan index files created
- DataView queries work in Obsidian
- Progress updates correctly
- Books array populated

---

## Success Metrics

1. **Adoption**: >50% of users actively use plan index dashboard
2. **Multi-Plan**: >25% of users run concurrent plans
3. **Queries**: Community shares custom DataView queries
4. **Feedback**: Positive response to centralized plan management

---

## References

- [Obsidian DataView](https://blacksmithgu.github.io/obsidian-dataview/)
- [YAML Specification](https://yaml.org/spec/1.2.2/)
- [ADR-001: Architecture](./ADR-001-bible-study-planner-architecture.md)

---

## Approval

- [ ] Architecture Approved
- [ ] Implementation Plan Approved
- [ ] DataView Queries Verified
- [ ] User Experience Reviewed
- [ ] Ready for Development

**Approved By**: _________________  
**Date**: _________________

---

## Changelog

| Date | Version | Changes | Author |
|------|---------|---------|--------|
| 2025-12-02 | 1.0 | Initial ADR with plan index approach | Development Team |
